rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // Users:
    // - Anyone can create a user document (for signup).
    // - Users can read/update their own document.
    // - Admins can read/list all users.
    match /users/{userId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth.uid == userId;
      allow list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Patient Profiles:
    // - A user's profile can be created.
    // - Patients can read/update their own profile.
    // - Doctors and Admins can read any patient's profile.
    // - Admins can list all profiles.
    match /patient_profiles/{patientId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth.uid == patientId;
      allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['doctor', 'admin'];
      allow list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['doctor', 'admin'];
    }

    // Health Vitals:
    // - Only trusted backend processes or authenticated devices should write vitals. For this app, we allow any authenticated user to simulate device writes.
    // - Patients can read their own vitals (by querying device_id).
    // - Doctors and Admins can read all vitals.
    match /health_vitals/{vitalId} {
      allow create: if request.auth != null;
      allow read, list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['doctor', 'admin'];
      allow read: if request.auth.uid == resource.data.patient_id; // Need to adjust for device_id query
    }

    // Alert History:
    // - Only trusted backend processes should create alerts. We allow any authenticated user for simulation.
    // - Doctors and Admins can read all alerts.
    // - Patients can read their own alerts.
    // - Doctors and Admins can update (acknowledge) alerts.
    match /alert_history/{alertId} {
      allow create: if request.auth != null;
      allow read, list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['doctor', 'admin'];
      allow read: if request.auth.uid == resource.data.patient_id;
      allow update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['doctor', 'admin'];
    }
  }
}
